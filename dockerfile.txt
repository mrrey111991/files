# Build stage
FROM docker-pluk-common.pruregistry.intranet.asia:8443/openjdk:21-jdk-slim as build
WORKDIR /app
COPY . .
RUN chmod +x ./pre-build.sh
RUN chmod +x ./gradlew
RUN ./pre-build.sh reset
RUN ./gradlew build --no-daemon
RUN ls -l ./build/libs && echo 1

# Production stage
FROM docker-pluk-common.pruregistry.intranet.asia:8443/tomcat:10.1.44-jdk21

# Environment variables
ENV TOMCAT_HOME=/usr/local/tomcat

# Ensure APT uses HTTPS
RUN sed -i 's|http://|https://|g' /etc/apt/sources.list && \
    find /etc/apt/sources.list.d -type f -exec sed -i 's|http://|https://|g' {} +

# Install dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    unzip \
    telnet \
    gnupg \
    apt-transport-https \
    && rm -rf /var/lib/apt/lists/*

# Install updated Ubuntu version and patch vulnerable packages
RUN echo "deb https://archive.ubuntu.com/ubuntu noble main restricted universe multiverse" > /etc/apt/sources.list && \
    echo "deb https://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb https://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse" >> /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y --only-upgrade \
    dpkg \
    curl \
    libcurl4t64 \
    openssl \
    libssl3t64 \
    libpam-modules \
    libpam-runtime \
    libpam-modules-bin \
    libpam0g \
    libexpat1 \
    expat \
    libc-bin \
    libc6 \
    locales \
    libsystemd0 \
    libudev1 \
    libssh-4 \
    libgnutls30t64 \
    systemd \
    sqlite3 \
    libsqlite3-0 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Add Microsoft GPG key and repo for MSSQL tools
RUN curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | apt-key add - && \
    curl -fsSL https://packages.microsoft.com/config/ubuntu/22.04/prod.list > /etc/apt/sources.list.d/mssql-release.list && \
    apt-get update && ACCEPT_EULA=Y apt-get install -y mssql-tools unixodbc-dev

# Link sqlcmd for easy access
RUN echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc && \
    ln -s /opt/mssql-tools/bin/sqlcmd /usr/local/bin/sqlcmd && \
    rm -rf /var/lib/apt/lists/*

# Copy build artifacts from the build stage
COPY --from=build /app/fish-startup.sh $TOMCAT_HOME/bin/fish-startup.sh
COPY --from=build /app/test-api.sh $TOMCAT_HOME/bin/test-api.sh
COPY --from=build /app/run-mssql-scripts.sh $TOMCAT_HOME/bin/run-mssql-scripts.sh
COPY --from=build /app/database/ $TOMCAT_HOME/bin/database/
COPY --from=build /app/tomcat/ $TOMCAT_HOME/conf/
COPY --from=build /app/build/libs/*.war $TOMCAT_HOME/webapps/fish.war

# Prepare Tomcat
RUN mkdir $TOMCAT_HOME/cmd
RUN chmod +x $TOMCAT_HOME/bin/*.sh

# Webapp startup
CMD ["fish-startup.sh"]
EXPOSE 8080

#test deployment


#fix

# ===== Build stage =====
FROM docker-pluk-common.pruregistry.intranet.asia:8443/openjdk:21-jdk-slim as build
WORKDIR /app
COPY . .
RUN chmod +x ./pre-build.sh ./gradlew
RUN ./pre-build.sh reset
RUN ./gradlew build --no-daemon
RUN ls -l ./build/libs && echo 1

# ===== Production stage =====
FROM docker-pluk-common.pruregistry.intranet.asia:8443/tomcat:10.1.44-jdk21

ENV TOMCAT_HOME=/usr/local/tomcat

# Use HTTPS for apt sources
RUN sed -i 's|http://|https://|g' /etc/apt/sources.list && \
    find /etc/apt/sources.list.d -type f -exec sed -i 's|http://|https://|g' {} +

# --- Security Fix: upgrade all vulnerable system libraries ---
RUN apt-get update && \
    apt-get -y --no-install-recommends upgrade && \
    apt-get -y --no-install-recommends install \
        curl \
        unzip \
        telnet \
        gnupg \
        apt-transport-https \
        unixodbc-dev \
        libc-bin \
        libc6 \
        libssl3 \
        openssl \
        libexpat1 \
        libpam-runtime \
        libpam0g \
        libpam-modules \
        libpam-modules-bin \
        locales && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# --- MSSQL Tools (Debian 12 version) ---
RUN curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | apt-key add - && \
    curl -fsSL https://packages.microsoft.com/config/debian/12/prod.list \
        > /etc/apt/sources.list.d/mssql-release.list && \
    apt-get update && ACCEPT_EULA=Y apt-get install -y --no-install-recommends mssql-tools && \
    ln -s /opt/mssql-tools/bin/sqlcmd /usr/local/bin/sqlcmd && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# --- Copy build artifacts ---
COPY --from=build /app/fish-startup.sh $TOMCAT_HOME/bin/
COPY --from=build /app/test-api.sh $TOMCAT_HOME/bin/
COPY --from=build /app/run-mssql-scripts.sh $TOMCAT_HOME/bin/
COPY --from=build /app/database/ $TOMCAT_HOME/bin/database/
COPY --from=build /app/tomcat/ $TOMCAT_HOME/conf/
COPY --from=build /app/build/libs/*.war $TOMCAT_HOME/webapps/fish.war

# --- Permissions and runtime setup ---
RUN chmod +x $TOMCAT_HOME/bin/*.sh && mkdir -p $TOMCAT_HOME/cmd

EXPOSE 8080
CMD ["fish-startup.sh"]






#18 7.924 Reading package lists...
#18 9.165 W: GPG error: https://packages.microsoft.com/debian/12/prod bookworm InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY EB3E94ADBE1229CF
#18 9.165 E: The repository 'https://packages.microsoft.com/debian/12/prod bookworm InRelease' is not signed.
#18 ERROR: process "/bin/sh -c curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | apt-key add - &&     curl -fsSL https://packages.microsoft.com/config/debian/12/prod.list         > /etc/apt/sources.list.d/mssql-release.list &&     apt-get update && ACCEPT_EULA=Y apt-get install -y --no-install-recommends mssql-tools &&     ln -s /opt/mssql-tools/bin/sqlcmd /usr/local/bin/sqlcmd &&     apt-get clean && rm -rf /var/lib/apt/lists/*" did not complete successfully: exit code: 100

#17 [build 7/8] RUN ./gradlew build --no-daemon
#17 CANCELED
------
 > [stage-1  4/12] RUN curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | apt-key add - &&     curl -fsSL https://packages.microsoft.com/config/debian/12/prod.list         > /etc/apt/sources.list.d/mssql-release.list &&     apt-get update && ACCEPT_EULA=Y apt-get install -y --no-install-recommends mssql-tools &&     ln -s /opt/mssql-tools/bin/sqlcmd /usr/local/bin/sqlcmd &&     apt-get clean && rm -rf /var/lib/apt/lists/*:
6.650 Get:13 https://archive.ubuntu.com/ubuntu noble/multiverse amd64 Packages [331 kB]
6.672 Get:14 https://archive.ubuntu.com/ubuntu noble-updates/main amd64 Packages [1,897 kB]
6.812 Get:15 https://archive.ubuntu.com/ubuntu noble-updates/universe amd64 Packages [1,928 kB]
6.954 Get:16 https://archive.ubuntu.com/ubuntu noble-updates/restricted amd64 Packages [2,644 kB]
7.155 Get:17 https://archive.ubuntu.com/ubuntu noble-updates/multiverse amd64 Packages [38.9 kB]
7.158 Get:18 https://archive.ubuntu.com/ubuntu noble-backports/universe amd64 Packages [33.9 kB]
7.160 Get:19 https://archive.ubuntu.com/ubuntu noble-backports/main amd64 Packages [49.4 kB]

9.165 W: GPG error: https://packages.microsoft.com/debian/12/prod bookworm InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY EB3E94ADBE1229CF
9.165 E: The repository 'https://packages.microsoft.com/debian/12/prod bookworm InRelease' is not signed.
------

 1 warning found (use docker --debug to expand):
 - FromAsCasing: 'as' and 'FROM' keywords' casing do not match (line 2)
Dockerfile:44
--------------------
  43 |     # Add Microsoft GPG key and repo for MSSQL tools
  44 | >>> RUN curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | apt-key add - && \
  45 | >>>     curl -fsSL https://packages.microsoft.com/config/debian/12/prod.list \
  46 | >>>         > /etc/apt/sources.list.d/mssql-release.list && \
  47 | >>>     apt-get update && ACCEPT_EULA=Y apt-get install -y --no-install-recommends mssql-tools && \
  48 | >>>     ln -s /opt/mssql-tools/bin/sqlcmd /usr/local/bin/sqlcmd && \
  49 | >>>     apt-get clean && rm -rf /var/lib/apt/lists/*
  50 |     
--------------------
ERROR: failed to build: failed to solve: process "/bin/sh -c curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | apt-key add - &&     curl -fsSL https://packages.microsoft.com/config/debian/12/prod.list         > /etc/apt/sources.list.d/mssql-release.list &&     apt-get update && ACCEPT_EULA=Y apt-get install -y --no-install-recommends mssql-tools &&     ln -s /opt/mssql-tools/bin/sqlcmd /usr/local/bin/sqlcmd &&     apt-get clean && rm -rf /var/lib/apt/lists/*" did not complete successfully: exit code: 100
Error: Process completed with exit code 1.




